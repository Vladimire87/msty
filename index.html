<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTY Average Price Reducer — Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="How many MSTY shares to buy at price P to bring average below (or ≤) target T." />
  <style>
    :root { --ring: rgba(255,255,255,0.08); }
    body { font-feature-settings: "tnum" 1, "cv02" 1; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
  <main class="min-h-screen grid place-items-center p-4 sm:p-6">
    <div class="w-full max-w-3xl">
      <div class="bg-white/5 backdrop-blur-xl rounded-3xl shadow-2xl p-6 sm:p-8 md:p-10 ring-1 ring-[var(--ring)]">
        <!-- Header -->
        <header class="text-center mb-6 sm:mb-8">
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">MSTY Average Price Reducer</h1>
          <p class="text-slate-300 mt-3 text-base sm:text-lg">
            For <span class="font-semibold">MSTY</span> (YieldMax MSTR Option Income Strategy ETF). Enter your numbers — we’ll tell you how many shares to buy.
          </p>
        </header>

        <!-- Live price (auto-used for P) -->
        <section class="mb-8 rounded-3xl border border-sky-500/30 bg-sky-500/10 p-5 sm:p-6">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
            <div>
              <p class="text-slate-300 text-sm sm:text-base">Live MSTY price</p>
              <div class="flex items-end gap-3">
                <p id="livePrice" class="text-3xl sm:text-4xl md:text-5xl font-extrabold tabular-nums">$—</p>
                <span id="pStatus" class="text-xs sm:text-sm px-2 py-1 rounded-lg border border-slate-600 text-slate-300">waiting…</span>
              </div>
              <p id="liveTime" class="text-xs text-slate-400 mt-1">Fetching…</p>
            </div>
            <div class="text-right text-[11px] sm:text-xs text-slate-400">
              <p>Source: Stooq (msty.us) via CORS mirror.</p>
              <p>If it fails, you can enter P manually.</p>
            </div>
          </div>
        </section>

        <!-- Calculator form -->
        <form id="calcForm" class="space-y-6" onsubmit="event.preventDefault(); calculate();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Shares -->
            <div>
              <label for="shares" class="block text-slate-200 font-medium mb-2 text-base sm:text-lg">
                Current shares (S) <span class="text-slate-400 text-sm">(required)</span>
              </label>
              <input id="shares" inputmode="decimal" placeholder="e.g., 1000"
                     class="w-full px-4 sm:px-5 py-3.5 sm:py-4 text-base sm:text-lg rounded-2xl bg-slate-900/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     aria-label="Current shares">
              <p class="mt-2 text-xs sm:text-sm text-slate-400">Your current position size. Fractional shares are OK.</p>
            </div>

            <!-- Cost basis -->
            <div>
              <label for="cost" class="block text-slate-200 font-medium mb-2 text-base sm:text-lg">
                Current cost basis, $ (C) <span class="text-slate-400 text-sm">(required* or Avg)</span>
              </label>
              <input id="cost" inputmode="decimal" placeholder="e.g., 25000.00"
                     class="w-full px-4 sm:px-5 py-3.5 sm:py-4 text-base sm:text-lg rounded-2xl bg-slate-900/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     aria-label="Current cost basis">
              <p class="mt-2 text-xs sm:text-sm text-slate-400">
                Total dollars invested (excl. fees). If you don’t know C, leave it empty and fill “Avg” — we’ll use <span class="font-mono">C = S × Avg</span>.
              </p>
            </div>

            <!-- Avg (optional) -->
            <div>
              <label for="avg" class="block text-slate-200 font-medium mb-2 text-base sm:text-lg">
                Current average price, $ (Avg) <span class="text-slate-400 text-sm">(optional)</span>
              </label>
              <input id="avg" inputmode="decimal" placeholder="e.g., 23.35"
                     class="w-full px-4 sm:px-5 py-3.5 sm:py-4 text-base sm:text-lg rounded-2xl bg-slate-900/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     aria-label="Current average price">
              <p class="mt-2 text-xs sm:text-sm text-slate-400">Used only if C is empty.</p>
            </div>

            <!-- Buy price -->
            <div>
              <label for="price" class="block text-slate-200 font-medium mb-2 text-base sm:text-lg">
                Buy price, $ (P) <span class="text-slate-400 text-sm">(required)</span>
              </label>
              <input id="price" inputmode="decimal" placeholder="auto-filled from live price"
                     class="w-full px-4 sm:px-5 py-3.5 sm:py-4 text-base sm:text-lg rounded-2xl bg-slate-900/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     aria-label="Buy price">
              <p class="mt-2 text-xs sm:text-sm text-slate-400">Auto-filled from live MSTY price; you can override it.</p>
            </div>

            <!-- Target -->
            <div>
              <label for="target" class="block text-slate-200 font-medium mb-2 text-base sm:text-lg">
                Target average, $ (T) <span class="text-slate-400 text-sm">(required)</span>
              </label>
              <input id="target" inputmode="decimal" placeholder="e.g., 23.00"
                     class="w-full px-4 sm:px-5 py-3.5 sm:py-4 text-base sm:text-lg rounded-2xl bg-slate-900/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     aria-label="Target average">
              <p class="mt-2 text-xs sm:text-sm text-slate-400">Your desired new average.</p>
            </div>

            <!-- Strict toggle -->
            <div class="flex items-center gap-3 pt-2">
              <input id="strict" type="checkbox" class="h-6 w-6 rounded border-slate-700 text-indigo-600 focus:ring-indigo-500" checked>
              <label for="strict" class="text-base sm:text-lg text-slate-200">
                Require strictly <span class="font-semibold">&lt; T</span> <span class="text-slate-400 text-sm">(unchecked: allow ≤ T)</span>
              </label>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row items-center gap-4 pt-2">
            <button type="submit"
                    class="w-full sm:w-auto px-6 sm:px-7 py-3.5 sm:py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 font-semibold text-base sm:text-lg shadow-lg shadow-indigo-600/20">
              Calculate
            </button>
            <button type="button" onclick="resetForm();"
                    class="w-full sm:w-auto px-6 sm:px-7 py-3.5 sm:py-4 rounded-2xl bg-slate-700 hover:bg-slate-600 active:bg-slate-800 font-semibold text-base sm:text-lg">
              Reset
            </button>
          </div>
        </form>

        <!-- Messages -->
        <div id="msg" class="mt-6 hidden rounded-2xl border p-4 text-sm sm:text-base" role="status" aria-live="polite"></div>

        <!-- Result -->
        <section id="result" class="mt-6 hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div class="rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-5 sm:p-6">
              <p class="text-slate-300 text-sm sm:text-base">Shares to buy</p>
              <p id="need" class="text-3xl sm:text-4xl font-extrabold">—</p>
            </div>
            <div class="rounded-2xl border border-indigo-500/30 bg-indigo-500/10 p-5 sm:p-6">
              <p class="text-slate-300 text-sm sm:text-base">Additional spend</p>
              <p id="spend" class="text-3xl sm:text-4xl font-extrabold">—</p>
            </div>
            <div class="rounded-2xl border border-slate-600 bg-slate-900/40 p-5 sm:p-6">
              <p class="text-slate-300 text-sm sm:text-base">Final shares</p>
              <p id="finalShares" class="text-2xl sm:text-3xl font-bold">—</p>
            </div>
            <div class="rounded-2xl border border-slate-600 bg-slate-900/40 p-5 sm:p-6">
              <p class="text-slate-300 text-sm sm:text-base">Final cost basis</p>
              <p id="finalCost" class="text-2xl sm:text-3xl font-bold">—</p>
            </div>
            <div class="md:col-span-2 rounded-2xl border border-yellow-500/30 bg-yellow-500/10 p-5 sm:p-6">
              <p class="text-slate-300 text-sm sm:text-base">New average price</p>
              <p id="newAvg" class="text-3xl sm:text-4xl font-extrabold">—</p>
            </div>
          </div>
          <p id="note" class="mt-3 text-xs sm:text-sm text-slate-400"></p>
        </section>

        <!-- Footer -->
        <footer class="mt-8 text-xs sm:text-sm text-slate-400 leading-relaxed">
          Formula (when P &lt; T): for strict “&lt; T” use <span class="font-mono">⌊(C − T·S)/(T − P)⌋ + 1</span>;
          for “≤ T” use <span class="font-mono">⌈(C − T·S)/(T − P)⌉</span>.
          If <span class="font-mono">C</span> is omitted, we use <span class="font-mono">C = S·Avg</span>. Fees/taxes ignored.
        </footer>
      </div>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // ---------- Helpers ----------
    function parseNum(v) {
      if (typeof v !== "string") return NaN;
      v = v.replace(/\s+/g, "").replace(",", ".");
      if (v === "") return NaN;
      return Number(v);
    }
    const fmtMoney = (x) => isFinite(x) ? ("$" + x.toFixed(2)) : "—";
    const fmtTime = (tsSec) => {
      try { return new Date(tsSec * 1000).toLocaleString(); } catch { return "—"; }
    };
    function showMsg(text, type = "info") {
      const box = $("msg");
      box.classList.remove(
        "hidden",
        "border-red-500/40","bg-red-500/10","text-red-200",
        "border-amber-500/40","bg-amber-500/10","text-amber-200",
        "border-sky-500/40","bg-sky-500/10","text-sky-200"
      );
      const cls = type === "error"
        ? ["border-red-500/40","bg-red-500/10","text-red-200"]
        : type === "warn"
        ? ["border-amber-500/40","bg-amber-500/10","text-amber-200"]
        : ["border-sky-500/40","bg-sky-500/10","text-sky-200"];
      box.classList.add(...cls, "border");
      box.innerText = text;
    }
    function hideMsg() { const box = $("msg"); box.classList.add("hidden"); box.innerText = ""; }

    // ---------- Calculator ----------
    function calculate() {
      hideMsg();
      const S = parseNum($("shares").value);
      let   C = parseNum($("cost").value);
      const Avg = parseNum($("avg").value);
      const P = parseNum($("price").value);
      const T = parseNum($("target").value);
      const strict = $("strict").checked;

      if (!isFinite(S) || S <= 0) { showMsg("Please enter a valid number of shares S (> 0).", "error"); return; }
      if (!isFinite(P) || P <= 0) { showMsg("Please enter a valid buy price P (> 0).", "error"); return; }
      if (!isFinite(T) || T <= 0) { showMsg("Please enter a valid target average T (> 0).", "error"); return; }

      if (!isFinite(C)) {
        if (isFinite(Avg) && Avg > 0) { C = S * Avg; }
        else { showMsg("Provide either cost basis C, or current average price Avg.", "error"); $("result").classList.add("hidden"); return; }
      }

      const currentAvg = C / S;
      const eps = 1e-12;

      if (strict ? (currentAvg < T - eps) : (currentAvg <= T + eps)) {
        renderResult(0, S, C, P, T, currentAvg, strict,
          strict ? "Your current average is already below the target — no additional shares needed."
                 : "Your current average is already ≤ the target — no additional shares needed.");
        return;
      }

      if (P >= T - eps) {
        showMsg("You cannot reduce the average to T if the buy price P ≥ T. Either raise T or buy at a lower price.", "warn");
        $("result").classList.add("hidden");
        return;
      }

      // x = (C - T*S) / (T - P)
      const x = (C - T * S) / (T - P);
      const N = Math.max(0, strict ? Math.floor(x) + 1 : Math.ceil(x));
      renderResult(N, S, C, P, T, currentAvg, strict);
    }

    function renderResult(N, S, C, P, T, currentAvg, strict, noteOverride = "") {
      const finalShares = S + N;
      const spend = N * P;
      const finalCost = C + spend;
      const newAvg = finalCost / finalShares;

      $("need").innerText = N.toString();
      $("spend").innerText = fmtMoney(spend);
      $("finalShares").innerText = finalShares.toString();
      $("finalCost").innerText = fmtMoney(finalCost);
      $("newAvg").innerText = "$" + newAvg.toFixed(4);

      let note = noteOverride;
      if (!note) {
        const cond = strict ? "< T" : "≤ T";
        note = `Condition "${cond}" is targeted with these inputs. Prior average was $${currentAvg.toFixed(4)}.`;
        const eps = 1e-12;
        if (strict ? !(newAvg < T - eps) : !(newAvg <= T + eps)) {
          note += " Result is on the edge due to rounding — add 1 more share for safety.";
        }
      }
      $("note").innerText = note;
      $("result").classList.remove("hidden");
    }

    function resetForm() {
      $("calcForm").reset();
      // keep everything empty; strict back to default
      $("strict").checked = true;
      $("result").classList.add("hidden");
      hideMsg();
      // do not clear live price or P if user wants to keep it
    }

    // ---------- Live price from Stooq via AllOrigins ----------
    async function fetchLivePrice() {
      const label = $("pStatus");
      try {
        const stooqURL = "https://stooq.com/q/l/?s=msty.us&f=sd2t2ohlcv&h&e=csv";
        const url = "https://api.allorigins.win/raw?url=" + encodeURIComponent(stooqURL) + "&" + Date.now();
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const csv = await r.text();

        const lines = csv.trim().split(/\r?\n/);
        if (lines.length < 2) throw new Error("No data");
        const header = lines[0].split(",");
        const row = lines[1].split(",");

        const idxClose = header.findIndex(h => /close/i.test(h));
        const idxDate  = header.findIndex(h => /^date$/i.test(h) || /d2/i.test(h));
        const idxTime  = header.findIndex(h => /^time$/i.test(h) || /t2/i.test(h));

        const price = parseFloat(row[idxClose]);
        const day = row[idxDate] || "";
        const tm  = row[idxTime] || "";

        if (!isFinite(price)) throw new Error("Price parse failed");

        const ts = day ? (Date.parse(day + (tm ? "T" + tm : "")) / 1000) : Math.floor(Date.now()/1000);

        $("livePrice").textContent = "$" + price.toFixed(2);
        $("liveTime").textContent = "Updated: " + fmtTime(ts) + " • Stooq";
        label.textContent = "auto-filled into P";
        label.className = "text-xs sm:text-sm px-2 py-1 rounded-lg border border-emerald-600 text-emerald-300";

        // Auto-fill P if it's empty or invalid
        const pInput = $("price");
        const cur = parseNum(pInput.value);
        if (!isFinite(cur) || cur <= 0) pInput.value = price.toFixed(2);

      } catch (e) {
        $("livePrice").textContent = "$—";
        $("liveTime").textContent = "Update failed — enter P manually.";
        const label = $("pStatus");
        label.textContent = "manual entry";
        label.className = "text-xs sm:text-sm px-2 py-1 rounded-lg border border-amber-600 text-amber-300";
        showMsg((e && e.message) ? e.message : "Live fetch failed.", "warn");
      }
    }

    // Indicate when user overrides P
    $("price").addEventListener("input", () => {
      const label = $("pStatus");
      label.textContent = "manual override";
      label.className = "text-xs sm:text-sm px-2 py-1 rounded-lg border border-slate-600 text-slate-300";
    });

    // Kick off on load
    fetchLivePrice();
  </script>
</body>
</html>
