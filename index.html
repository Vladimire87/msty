<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTY Average Price Reducer — Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter var", "Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Ubuntu", "Cantarell", "Noto Sans", "Helvetica Neue", "Arial", "Apple Color Emoji", "Segoe UI Emoji"],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <meta name="description" content="How many MSTY shares to buy at price P to bring average below (or ≤) target T." />
  <style>
    :root { --ring: rgba(255,255,255,0.08); }
    body { font-feature-settings: "tnum" 1, "cv02" 1; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 font-sans">
  <!-- Top-centered layout; scrolls naturally on small screens -->
  <main class="min-h-screen flex justify-center px-3 py-4 md:px-4 md:py-6">
    <div class="w-full max-w-2xl">
      <div class="bg-slate-800/40 backdrop-blur-xl rounded-2xl shadow-2xl p-5 md:p-6 ring-1 ring-[var(--ring)]">
        <!-- Header -->
        <header class="text-center mb-4 md:mb-6">
          <div class="inline-flex items-center gap-2 rounded-full border border-slate-700/60 bg-slate-900/40 px-3 py-1 text-[11px] md:text-xs text-slate-300">
            <span class="inline-block h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
            <span>Calculator</span>
          </div>
          <h1 class="text-xl md:text-3xl font-extrabold tracking-tight mt-2">MSTY Average Price Reducer</h1>
          <p class="text-slate-300 mt-1 md:mt-2 text-sm md:text-base leading-relaxed">
            For <span class="font-semibold">MSTY</span> (YieldMax MSTR Option Income Strategy ETF). Enter your current position, target average, and buy price — we’ll calculate how many shares to buy.
          </p>
        </header>

        <!-- Live price (auto-used for P) -->
        <section class="mb-4 md:mb-6 rounded-2xl border border-sky-500/30 bg-gradient-to-br from-sky-500/10 to-sky-400/5 p-3 md:p-4">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
              <p class="text-slate-300 text-xs md:text-sm">Live MSTY price</p>
              <div class="flex items-end gap-2">
                <p id="livePrice" class="text-2xl md:text-4xl font-extrabold tabular-nums">$—</p>
                <span id="pStatus" class="text-[11px] md:text-xs px-2 py-0.5 rounded-md border border-slate-600 text-slate-300">waiting…</span>
              </div>
              <p id="liveTime" class="text-[10px] md:text-xs text-slate-400 mt-1">Fetching…</p>
            </div>
            <div class="text-right text-[10px] md:text-xs text-slate-400">
              <p>Source: Stooq/Yahoo via CORS mirror (r.jina.ai).</p>
              <p>If it fails, you can enter P manually.</p>
            </div>
          </div>
        </section>

        

        <!-- Calculator form -->
        <form id="calcForm" class="space-y-4" onsubmit="event.preventDefault(); calculate();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
            <!-- Shares -->
            <div>
              <label for="shares" class="block text-slate-200 font-medium mb-1 text-sm md:text-base">
                Current shares S <span class="text-slate-400 text-xs">(required)</span>
              </label>
              <input id="shares" inputmode="decimal" placeholder="e.g., 1000"
                     class="w-full px-3.5 py-2.5 text-sm md:text-base rounded-xl bg-slate-800/60 border border-slate-700 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-400/70 focus:border-sky-400/60"
                     aria-label="Current shares">
              <p class="mt-1 text-[11px] text-slate-400">Your current position size. Fractional shares are OK.</p>
            </div>

            <!-- Cost basis -->
            <div>
              <label for="cost" class="block text-slate-200 font-medium mb-1 text-sm md:text-base">
                Total cost basis C <span class="text-slate-400 text-xs">(required or use Avg)</span>
              </label>
              <div class="relative">
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                <input id="cost" inputmode="decimal" placeholder="e.g., 25000.00"
                       class="w-full pl-7 pr-3.5 py-2.5 text-sm md:text-base rounded-xl bg-slate-800/60 border border-slate-700 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-400/70 focus:border-sky-400/60"
                       aria-label="Current cost basis">
              </div>
              <p class="mt-1 text-[11px] text-slate-400">If you don’t know C, leave it empty and fill “Avg”.</p>
            </div>

            <!-- Avg (optional) -->
            <div>
              <label for="avg" class="block text-slate-200 font-medium mb-1 text-sm md:text-base">
                Average price Avg <span class="text-slate-400 text-xs">(optional)</span>
              </label>
              <div class="relative">
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                <input id="avg" inputmode="decimal" placeholder="e.g., 23.35"
                       class="w-full pl-7 pr-3.5 py-2.5 text-sm md:text-base rounded-xl bg-slate-800/60 border border-slate-700 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-400/70 focus:border-sky-400/60"
                       aria-label="Current average price">
              </div>
              <p class="mt-1 text-[11px] text-slate-400">Only used if C is empty.</p>
            </div>

            <!-- Buy price -->
            <div>
              <label for="price" class="block text-slate-200 font-medium mb-1 text-sm md:text-base">
                Buy price P <span class="text-slate-400 text-xs">(required)</span>
              </label>
              <div class="relative">
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                <input id="price" inputmode="decimal" placeholder="auto-filled from live price"
                       class="w-full pl-7 pr-3.5 py-2.5 text-sm md:text-base rounded-xl bg-slate-800/60 border border-slate-700 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-400/70 focus:border-sky-400/60"
                       aria-label="Buy price">
              </div>
              <p class="mt-1 text-[11px] text-slate-400">Auto-filled from MSTY live price; you can override.</p>
            </div>

            <!-- Target -->
            <div>
              <label for="target" class="block text-slate-200 font-medium mb-1 text-sm md:text-base">
                Target average T <span class="text-slate-400 text-xs">(required)</span>
              </label>
              <div class="relative">
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                <input id="target" inputmode="decimal" placeholder="e.g., 23.00"
                       class="w-full pl-7 pr-3.5 py-2.5 text-sm md:text-base rounded-xl bg-slate-800/60 border border-slate-700 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-400/70 focus:border-sky-400/60"
                       aria-label="Target average">
              </div>
            </div>

            <!-- Strict toggle -->
            <div class="flex items-center gap-2 pt-1">
              <input id="strict" type="checkbox" class="h-5 w-5 rounded border-slate-700 text-sky-600 focus:ring-sky-500" checked>
              <label for="strict" class="text-sm md:text-base text-slate-200">
                Require strictly <span class="font-semibold">&lt; T</span> <span class="text-slate-400 text-xs">(unchecked: allow ≤ T)</span>
              </label>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row items-center gap-2.5 pt-1">
            <button type="submit"
                    class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-sky-600 hover:bg-sky-500 active:bg-sky-700 text-white font-semibold text-sm md:text-base shadow-lg shadow-sky-600/20 focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-sky-400/70">
              Calculate
            </button>
            <button type="button" onclick="resetForm();"
                    class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 active:bg-slate-800 font-semibold text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-slate-400/50">
              Reset
            </button>
          </div>
        </form>

        <!-- Messages -->
        <div id="msg" class="mt-5 hidden rounded-xl border p-3 text-sm md:text-base" role="status" aria-live="polite"></div>

        <!-- Result -->
        <section id="result" class="mt-5 hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
            <div class="rounded-xl border border-emerald-600/30 bg-gradient-to-br from-emerald-600/10 to-emerald-500/5 p-3 md:p-4">
              <p class="text-slate-300 text-sm md:text-base">Shares to buy</p>
              <p id="need" class="text-2xl md:text-3xl font-extrabold">—</p>
            </div>
            <div class="rounded-xl border border-indigo-500/30 bg-gradient-to-br from-indigo-500/10 to-indigo-400/5 p-3 md:p-4">
              <p class="text-slate-300 text-sm md:text-base">Additional spend</p>
              <p id="spend" class="text-2xl md:text-3xl font-extrabold">—</p>
            </div>
            <div class="rounded-xl border border-slate-700 bg-slate-900/40 p-3 md:p-4">
              <p class="text-slate-300 text-sm md:text-base">Final shares</p>
              <p id="finalShares" class="text-xl md:text-2xl font-bold">—</p>
            </div>
            <div class="rounded-xl border border-slate-700 bg-slate-900/40 p-3 md:p-4">
              <p class="text-slate-300 text-sm md:text-base">Final cost basis</p>
              <p id="finalCost" class="text-xl md:text-2xl font-bold">—</p>
            </div>
            <div class="md:col-span-2 rounded-xl border border-amber-500/30 bg-gradient-to-br from-amber-500/10 to-amber-400/5 p-3 md:p-4">
              <p class="text-slate-300 text-sm md:text-base">New average price</p>
              <p id="newAvg" class="text-2xl md:text-3xl font-extrabold">—</p>
            </div>
          </div>
          <p id="note" class="mt-2 text-xs md:text-sm text-slate-400"></p>
        </section>

        <!-- Chart -->
        <section id="chart-container" class="mt-4 md:mt-5 hidden">
          <h2 class="text-lg md:text-2xl font-bold text-center mb-3 md:mb-4">MSTY Historical Price (30 days)</h2>
          <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 p-3">
            <canvas id="priceChart"></canvas>
          </div>
          <div id="chartImageWrap" class="hidden">
            <img id="priceChartImg" alt="MSTY daily chart (fallback)" class="w-full rounded-xl border border-slate-700/60" />
            <p id="chartFallbackNote" class="mt-2 text-xs text-slate-400 text-center">Fallback chart (image) loaded due to data source issues.</p>
          </div>
        </section>

        <!-- Quick Guide / FAQ -->
        <section class="mt-6 rounded-2xl border border-slate-700/60 bg-slate-900/40 p-3 md:p-4">
          <button id="guideToggle" type="button" class="w-full flex items-center justify-between gap-3 px-2 py-2 rounded-lg hover:bg-slate-800/40 focus:outline-none focus:ring-2 focus:ring-slate-400/50" aria-expanded="false" aria-controls="guide">
            <span class="text-left text-base md:text-lg font-bold">Quick Guide</span>
            <svg id="guideChevron" class="h-4 w-4 text-slate-300 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
          </button>
          <div id="guide" class="hidden mt-2">
            <ul class="list-disc pl-5 space-y-1 text-[13px] md:text-sm text-slate-300">
              <li><span class="font-semibold">S — Current shares:</span> total MSTY shares you already own. Fractionals OK.</li>
              <li><span class="font-semibold">C — Total cost basis ($):</span> how much you’ve spent. If unknown, leave empty and use <span class="font-semibold">Avg</span>.</li>
              <li><span class="font-semibold">Avg — Current average ($):</span> used only when <span class="font-semibold">C</span> is empty; uses <span class="font-mono">C = S × Avg</span>.</li>
              <li><span class="font-semibold">P — Buy price ($):</span> auto‑filled from live quote; adjust if planning different price.</li>
              <li><span class="font-semibold">T — Target average ($):</span> average price you want after buying more shares.</li>
              <li><span class="font-semibold">Strict &lt; T:</span> checked guarantees new average is strictly below <span class="font-semibold">T</span>; unchecked allows <span class="font-mono">≤ T</span>.</li>
            </ul>
            <p class="mt-2 text-[11px] md:text-xs text-slate-400">
              Tip: If results look borderline due to rounding, add 1 extra share for safety.
            </p>
          </div>
        </section>

        <!-- Footer -->
        <footer class="mt-6 text-xs md:text-sm text-slate-400 leading-relaxed">
          Formula (when P &lt; T): for strict “&lt; T” use <span class="font-mono">⌊(C − T·S)/(T − P)⌋ + 1</span>;
          for “≤ T” use <span class="font-mono">⌈(C − T·S)/(T − P)⌉</span>. If <span class="font-mono">C</span> is omitted, we use <span class="font-mono">C = S·Avg</span>. Fees/taxes ignored.
        </footer>
      </div>
    </div>
  </main>

  <script src="./parseNumber.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const DEBUG = false; // flip true to see detailed fetch errors
    const dbg = {
      error: (...a) => { if (DEBUG) console.error(...a); },
      warn:  (...a) => { if (DEBUG) console.warn(...a); },
      info:  (...a) => { if (DEBUG) console.info(...a); },
      log:   (...a) => { if (DEBUG) console.log(...a); },
    };

    // ---------- Helpers ----------
    const fmtMoney = (x) => isFinite(x) ? ("$" + x.toFixed(2)) : "—";
    const fmtTime = (tsSec) => {
      try { return new Date(tsSec * 1000).toLocaleString(); } catch { return "—"; }
    };
    async function fetchJSONWithTimeout(url, ms) {
      const timeout = withTimeout(ms);
      try {
        const res = await fetch(url, { cache: "no-store", signal: timeout.signal });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } finally {
        timeout.clear();
      }
    }
    function showMsg(text, type = "info") {
      const box = $("msg");
      box.classList.remove(
        "hidden",
        "border-red-500/40","bg-red-500/10","text-red-200",
        "border-amber-500/40","bg-amber-500/10","text-amber-200",
        "border-sky-500/40","bg-sky-500/10","text-sky-200"
      );
      const cls = type === "error"
        ? ["border-red-500/40","bg-red-500/10","text-red-200"]
        : type === "warn"
        ? ["border-amber-500/40","bg-amber-500/10","text-amber-200"]
        : ["border-sky-500/40","bg-sky-500/10","text-sky-200"];
      box.classList.add(...cls, "border");
      box.innerText = text;
    }
    function hideMsg() { const box = $("msg"); box.classList.add("hidden"); box.innerText = ""; }

    // ---------- Calculator ----------
    function calculate() {
      hideMsg();
      const S = parseNumber($("shares").value);
      let   C = parseNumber($("cost").value);
      const Avg = parseNumber($("avg").value);
      const P = parseNumber($("price").value);
      const T = parseNumber($("target").value);
      const strict = $("strict").checked;

      if (!isFinite(S) || S <= 0) { showMsg("Please enter a valid number of shares S (> 0).", "error"); return; }
      if (!isFinite(P) || P <= 0) { showMsg("Please enter a valid buy price P (> 0).", "error"); return; }
      if (!isFinite(T) || T <= 0) { showMsg("Please enter a valid target average T (> 0).", "error"); return; }

      if (!isFinite(C)) {
        if (isFinite(Avg) && Avg > 0) { C = S * Avg; }
        else { showMsg("Provide either cost basis C, or current average price Avg.", "error"); $("result").classList.add("hidden"); return; }
      }

      const currentAvg = C / S;
      const eps = 1e-12;

      if (strict ? (currentAvg < T - eps) : (currentAvg <= T + eps)) {
        renderResult(0, S, C, P, T, currentAvg, strict,
          strict ? "Your current average is already below the target — no additional shares needed."
                 : "Your current average is already ≤ the target — no additional shares needed.");
        return;
      }

      if (P >= T - eps) {
        showMsg("You cannot reduce the average to T if the buy price P ≥ T. Either raise T or buy at a lower price.", "warn");
        $("result").classList.add("hidden");
        return;
      }

      // x = (C - T*S) / (T - P)
      const x = (C - T * S) / (T - P);
      const N = Math.max(0, strict ? Math.floor(x) + 1 : Math.ceil(x));
      renderResult(N, S, C, P, T, currentAvg, strict);
    }

    function renderResult(N, S, C, P, T, currentAvg, strict, noteOverride = "") {
      const finalShares = S + N;
      const spend = N * P;
      const finalCost = C + spend;
      const newAvg = finalCost / finalShares;

      $("need").innerText = N.toString();
      $("spend").innerText = fmtMoney(spend);
      $("finalShares").innerText = finalShares.toString();
      $("finalCost").innerText = fmtMoney(finalCost);
      $("newAvg").innerText = "$" + newAvg.toFixed(4);

      let note = noteOverride;
      if (!note) {
        const cond = strict ? "< T" : "≤ T";
        note = `Condition "${cond}" is targeted with these inputs. Prior average was ${currentAvg.toFixed(4)}.`;
        const eps = 1e-12;
        if (strict ? !(newAvg < T - eps) : !(newAvg <= T + eps)) {
          note += " Result is on the edge due to rounding — add 1 more share for safety.";
        }
      }
      $("note").innerText = note;
      $("result").classList.remove("hidden");
    }

    function resetForm() {
      $("calcForm").reset();
      $("strict").checked = true;
      $("result").classList.add("hidden");
      hideMsg();
    }

    // ---------- Live price from Stooq with timeout/retries and fallback ----------
    function withTimeout(ms, signal) {
      const ctrl = new AbortController();
      const onAbort = () => ctrl.abort();
      if (signal) signal.addEventListener("abort", onAbort, { once: true });
      const t = setTimeout(() => ctrl.abort(), ms);
      return { signal: ctrl.signal, clear: () => { clearTimeout(t); if (signal) signal.removeEventListener("abort", onAbort); } };
    }

    async function fetchTextWithTimeout(url, ms) {
      const timeout = withTimeout(ms);
      try {
        const res = await fetch(url, { cache: "no-store", signal: timeout.signal });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.text();
      } finally {
        timeout.clear();
      }
    }

    function parseStooqCsv(csv) {
      const lines = csv.trim().split(/\r?\n/);
      const csvStartIndex = lines.findIndex(line => line.startsWith("Symbol,Date,Time"));
      if (csvStartIndex === -1) throw new Error("No CSV data found");

      const csvLines = lines.slice(csvStartIndex);
      if (csvLines.length < 2) throw new Error("No data");

      const header = csvLines[0].split(",");
      const row = csvLines[1].split(",");
      const idxClose = header.findIndex(h => /close/i.test(h));
      const idxOpen  = header.findIndex(h => /open/i.test(h));
      const idxDate  = header.findIndex(h => /^date$/i.test(h) || /d2/i.test(h));
      const idxTime  = header.findIndex(h => /^time$/i.test(h) || /t2/i.test(h));
      let priceStr = (idxClose >= 0 ? row[idxClose] : undefined) || "";
      // Stooq may return N/D when no data; try open as a fallback if close is N/D
      if (/^N\/?D$/i.test(priceStr) && idxOpen >= 0) priceStr = row[idxOpen] || "";
      const price = parseFloat(priceStr);
      const day = (idxDate >= 0 ? row[idxDate] : "") || "";
      const tm  = (idxTime >= 0 ? row[idxTime] : "") || "";
      if (!isFinite(price)) throw new Error("Price parse failed");
      const ts = day ? (Date.parse(day + (tm ? "T" + tm : "")) / 1000) : Math.floor(Date.now()/1000);
      return { price, ts };
    }

    async function fetchLivePrice() {
      const label = $("pStatus");
      const stooqUrls = [
        "https://stooq.com/q/l/?s=msty.us&f=sd2t2ohlcv&h&e=csv",
        "http://stooq.com/q/l/?s=msty.us&f=sd2t2ohlcv&h&e=csv",
      ];
      const yahooUrls = [
        "https://query1.finance.yahoo.com/v7/finance/quote?symbols=MSTY",
        "https://query2.finance.yahoo.com/v7/finance/quote?symbols=MSTY",
      ];

      const sources = [
        // Local API first (faster, avoids CORS)
        async () => {
          const data = await fetchJSONWithTimeout("/api/price?symbol=MSTY", 5000);
          const price = Number(data && data.price);
          const ts = Number(data && data.ts);
          if (!isFinite(price)) throw new Error("Local price parse failed");
          return { price, ts: isFinite(ts) ? ts : Math.floor(Date.now()/1000), labelText: "auto-filled (local API)", timeSuffix: " • Local" };
        },
        // Stooq via mirror (https and http variants)
        ...stooqUrls.map(u => async () => {
          const csv = await fetchTextWithTimeout("https://r.jina.ai/" + u, 6000);
          const { price, ts } = parseStooqCsv(csv);
          return { price, ts, labelText: "auto-filled from Stooq (mirror)", timeSuffix: " • Stooq" };
        }),
        // Yahoo via mirror (query1, query2)
        ...yahooUrls.map(u => async () => {
          const text = await fetchTextWithTimeout("https://r.jina.ai/" + u, 6000);
          const t = text.trim();
          if (!t.startsWith("{")) throw new Error("Yahoo proxy returned non-JSON");
          const data = JSON.parse(t);
          const q = data && data.quoteResponse && data.quoteResponse.result && data.quoteResponse.result[0];
          if (!q) throw new Error("Yahoo: no result");
          const price = Number(q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice);
          const ts = Number(q.regularMarketTime ?? q.postMarketTime ?? q.preMarketTime ?? Math.floor(Date.now()/1000));
          if (!isFinite(price)) throw new Error("Yahoo: price parse failed");
          return { price, ts, labelText: "auto-filled from Yahoo (mirror)", timeSuffix: " • Yahoo" };
        }),
      ];

      for (const s of sources) {
        try {
          const { price, ts, labelText, timeSuffix } = await s();
          $("livePrice").textContent = "$" + price.toFixed(2);
          $("liveTime").textContent = "Updated: " + fmtTime(ts) + timeSuffix;
          label.textContent = labelText;
          label.className = "text-[11px] md:text-xs px-2 py-0.5 rounded-md border border-emerald-600 text-emerald-300";
          const pInput = $("price");
          const cur = parseNumber(pInput.value);
          if (!isFinite(cur) || cur <= 0) pInput.value = price.toFixed(2);
          return;
        } catch (e) { /* try next */ }
      }

      $("livePrice").textContent = "$—";
      $("liveTime").textContent = "Update failed — enter P manually.";
      label.textContent = "manual entry";
      label.className = "text-[11px] md:text-xs px-2 py-0.5 rounded-md border border-amber-600 text-amber-300";
      showMsg("Live fetch failed.", "warn");
    }

    // Mark manual override of P
    $("price").addEventListener("input", () => {
      const label = $("pStatus");
  label.textContent = "manual override";
  label.className = "text-[11px] md:text-xs px-2 py-0.5 rounded-md border border-slate-600 text-slate-300";
    });

    // Kick off on load
    fetchLivePrice();
    
    // Distributions (Dividends) removed at user's request
    // Theme toggle removed

    // ---------- Historical Chart ----------
    async function fetchHistoricalData() {
      const stooqHistUrls = [
        "https://stooq.com/q/d/l/?s=MSTY.US&i=d&c=30",
        "http://stooq.com/q/d/l/?s=MSTY.US&i=d&c=30",
      ];
      const yahooHistUrls = [
        "https://query1.finance.yahoo.com/v8/finance/chart/MSTY?range=1mo&interval=1d",
        "https://query2.finance.yahoo.com/v8/finance/chart/MSTY?range=1mo&interval=1d",
      ];
      const sources = [
        // Local API first
        async () => {
          const data = await fetchJSONWithTimeout("/api/history?symbol=MSTY&range=30d", 6000);
          if (!data || !Array.isArray(data.labels) || data.labels.length < 2) throw new Error("Local history empty");
          return { labels: data.labels, prices: data.prices };
        },
        ...stooqHistUrls.map(u => async () => parseStooqHistoricalCsv(await fetchTextWithTimeout("https://r.jina.ai/" + u, 7000))),
        ...yahooHistUrls.map(u => async () => parseYahooHistoricalJson(await fetchTextWithTimeout("https://r.jina.ai/" + u, 7000))),
      ];
      for (const s of sources) {
        try {
          const data = await s();
          if (data && data.labels && data.labels.length >= 2) {
            $("chart-container").classList.remove("hidden");
            $("chartImageWrap").classList.add("hidden");
            $("priceChart").classList.remove("hidden");
            renderChart(data);
            return;
          }
        } catch (e) {
          dbg.warn("Historical source failed:", e && (e.message || e));
        }
      }
      // Fallback to image chart (no JS data needed)
      renderChartImageFallback();
    }

    function renderChartImageFallback() {
      const img = $("priceChartImg");
      // Finviz static chart image as a last-resort fallback
      const src = "https://charts2.finviz.com/chart.ashx?t=MSTY&p=d&ty=c&ta=1&s=l";
      img.onerror = () => {
        $("chartFallbackNote").textContent = "Fallback chart failed to load.";
      };
      img.src = src;
      $("chart-container").classList.remove("hidden");
      $("priceChart").classList.add("hidden");
      $("chartImageWrap").classList.remove("hidden");
    }

    function parseStooqHistoricalCsv(csv) {
      const lines = (csv || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      let start = lines.findIndex(l => /^date\s*,\s*open\s*,\s*high\s*,\s*low\s*,\s*close\s*,\s*volume/i.test(l));
      if (start !== -1) start += 1; // skip header
      else start = lines.findIndex(l => /^\d{4}-\d{2}-\d{2}\s*,/.test(l));
      if (start === -1) return null; // no usable CSV

      const labels = [];
      const prices = [];
      for (let i = start; i < lines.length; i++) {
        const parts = lines[i].split(",");
        if (parts.length < 5) continue;
        const date = parts[0];
        const closeStr = parts[4];
        if (/^N\/?D$/i.test(closeStr)) continue;
        const close = parseFloat(closeStr);
        if (date && isFinite(close)) {
          // oldest -> newest
          labels.push(date);
          prices.push(close);
        }
      }
      if (!labels.length) return null;
      return { labels, prices };
    }

    function parseYahooHistoricalJson(text) {
      const t = (text || "").trim();
      if (!t.startsWith("{")) return null; // e.g., proxy returned HTML
      const data = JSON.parse(t);
      const r = data && data.chart && data.chart.result && data.chart.result[0];
      if (!r) return null;
      const ts = Array.isArray(r.timestamp) ? r.timestamp : [];
      const quote = r.indicators && r.indicators.quote && r.indicators.quote[0] || {};
      const closes = Array.isArray(quote.close) ? quote.close : [];
      const labels = [];
      const prices = [];
      for (let i = 0; i < ts.length; i++) {
        const tm = Number(ts[i]);
        const c = Number(closes[i]);
        if (!isFinite(tm) || !isFinite(c)) continue;
        const day = new Date(tm * 1000).toISOString().slice(0, 10);
        labels.push(day);
        prices.push(c);
      }
      if (!labels.length) return null;
      return { labels, prices };
    }

    function renderChart(data) {
      const ctx = $("priceChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.labels,
          datasets: [{
            label: "Price",
            data: data.prices,
            borderColor: "#38bdf8",
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                color: "#94a3b8"
              },
              grid: {
                color: "rgba(148, 163, 184, 0.12)"
              }
            },
            y: {
              ticks: {
                color: "#94a3b8",
                callback: function(value) {
                  const num = Number(value);
                  return isFinite(num) ? ("$" + num.toFixed(2)) : value;
                }
              },
              grid: {
                color: "rgba(148, 163, 184, 0.12)"
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    fetchHistoricalData();

    // ---------- Quick Guide toggle ----------
    (function initGuideToggle() {
      const btn = $("guideToggle");
      const panel = $("guide");
      const chevron = $("guideChevron");
      if (!btn || !panel) return;
      function setOpen(open) {
        btn.setAttribute("aria-expanded", String(open));
        panel.classList.toggle("hidden", !open);
        if (chevron) chevron.style.transform = open ? "rotate(180deg)" : "rotate(0deg)";
      }
      // Default: collapsed on small screens, expanded on md+
      const mq = window.matchMedia("(min-width: 768px)");
      function applyMQ() { setOpen(mq.matches); }
      applyMQ();
      mq.addEventListener ? mq.addEventListener("change", applyMQ) : mq.addListener(applyMQ);
      btn.addEventListener("click", () => setOpen(btn.getAttribute("aria-expanded") !== "true"));
    })();
  </script>
</body>
</html>
